version: v1.0
name: FlowCrypt Android App
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
  containers:
    - name: main
      image: semaphoreci/android:29
global_job_config:
  env_vars:
    - name: SEMAPHORE_GIT_DIR
      value: ~/git/flowcrypt-android
  prologue:
    commands:
      - export PATH=${ANDROID_HOME}/emulator:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools:${PATH}
      - checkout && cd ~
      # restore caches
      - export SUM=$(checksum $SEMAPHORE_GIT_DIR/build.gradle)-$(checksum $SEMAPHORE_GIT_DIR/FlowCrypt/build.gradle)-$(checksum $SEMAPHORE_GIT_DIR/script/ci-install-android-sdk.sh)
      - export GRADLE_CACHE=gradle-cache-$SUM # per conf files hash
      - export BUILD_NATIVE_CACHE=build-native-cache-$SEMAPHORE_GIT_BRANCH-$SUM  # per branch and conf files hash
      - export BUILD_CACHE=build-cache-$SEMAPHORE_GIT_BRANCH-$SUM  # per branch and conf files hash
      - cache restore $GRADLE_CACHE
      - cache restore $BUILD_NATIVE_CACHE
      - cache restore $BUILD_CACHE
blocks:
  - name: Test without mailserver
    execution_time_limit:
      minutes: 30
    task:
      jobs:
        - name: Test without mailserver
          commands:
            - sudo rm -rf ~/.rbenv ~/.phpbrew
            - cat /proc/cpuinfo
            # Install Android dependencies
            - ( cd $SEMAPHORE_GIT_DIR && ./script/ci-install-android-sdk.sh )
            # Enable gradle daemon. https://docs.gradle.org/current/userguide/gradle_daemon.html#sec:disabling_the_daemon
            - sudo mkdir -p ~/.gradle && echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
            # run Lint checks
            - ( cd $SEMAPHORE_GIT_DIR && ./script/ci-lint-checks.sh )
            # run JUnit tests
            - ( cd $SEMAPHORE_GIT_DIR && ./script/ci-junit-tests.sh )
            # Setup and run an emulator
            - echo no | avdmanager -v create avd -n ci-test-pixel-x86-64-api29 -k "system-images;android-29;google_apis;x86_64"
            - emulator -list-avds # debug
            - emulator -avd ci-test-pixel-x86-64-api29 -no-window -no-boot-anim -no-audio -gpu auto& # start emulator in the background
            - $SEMAPHORE_GIT_DIR/script/ci-wait-for-emulator.sh # wait till ready
            # Run instrumentation tests
            - ( cd $SEMAPHORE_GIT_DIR && ./script/ci-tests-without-mailserver.sh )

      epilogue:
        on_fail:
          commands:
            - artifact push job --expire-in 1w $SEMAPHORE_GIT_DIR/FlowCrypt/build/reports/androidTests/connected/flavors/DEVTEST/
        on_pass:
          commands:
            # store caches
            - cd $SEMAPHORE_GIT_DIR
            - cache clear
            - find ~/.gradle/caches/ -name "*.lock" -type f -delete # https://medium.com/cirruslabs/mastering-gradle-caching-and-incremental-builds-37eb1af7fcde
            - cache store $GRADLE_CACHE $SEMAPHORE_GIT_DIR/.gradle
            - cache store $BUILD_NATIVE_CACHE $SEMAPHORE_GIT_DIR/FlowCrypt/.externalNativeBuild
            - cache store $BUILD_CACHE $SEMAPHORE_GIT_DIR/flowcrypt-android/FlowCrypt/build