version: v1.0
name: FlowCrypt Android App
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
global_job_config:
  env_vars:
    - name: SEMAPHORE_GIT_DIR
      value: /home/semaphore/git/flowcrypt-android
    - name: ANDROID_SDK_ROOT
      value: /home/semaphore/Android/Sdk
  prologue:
    commands:
      - export PATH=${ANDROID_SDK_ROOT}/emulator:${ANDROID_SDK_ROOT}/tools:${ANDROID_SDK_ROOT}/tools/bin:${ANDROID_SDK_ROOT}/platform-tools:${PATH}
      - sudo rm -rf ~/.rbenv ~/.phpbrew
      - checkout
      # restore caches
      - export SUM=$(checksum build.gradle)-$(checksum FlowCrypt/build.gradle)-$(checksum ./script/ci-install-android-sdk.sh)
      - export GRADLE_CACHE=gradle-cache-$SUM # per conf files hash
      - export ANDROID_SDK_CACHE=android-sdk-$SUM # per conf files hash
      - export BUILD_NATIVE_CACHE=build-native-cache-$SEMAPHORE_GIT_BRANCH-$SUM  # per branch and conf files hash
      - export BUILD_CACHE=build-cache-$SEMAPHORE_GIT_BRANCH-$SUM  # per branch and conf files hash
      - cache restore $GRADLE_CACHE
      - cache restore $ANDROID_SDK_CACHE
      - cache restore $BUILD_NATIVE_CACHE
      - cache restore $BUILD_CACHE
      # Install Android dependencies
      - ./script/ci-install-android-sdk.sh
blocks:
  - name: Testing
    execution_time_limit:
      minutes: 59
    task:
      jobs:
        - name: Lint
          commands:
            - cat /proc/cpuinfo
            # run Lint checks
            - ./script/ci-lint-checks.sh

        - name: JUnit tests
          commands:
            # run JUnit tests
            - ./script/ci-junit-tests.sh

        - name: Instrumentation tests(No email server) - part 1
          commands:
            # Setup and run an emulator
            - $ANDROID_SDK_ROOT/emulator/emulator -accel-check
            - echo -ne '\n' | avdmanager -v create avd --name ci-test-pixel-x86-64-api29 --package "system-images;android-29;google_apis;x86_64" --device 'pixel' --abi 'google_apis/x86_64'
            - cat ~/.android/avd/ci-test-pixel-x86-64-api29.avd/config.ini
            - $ANDROID_SDK_ROOT/emulator/emulator -list-avds #debug
            - $ANDROID_SDK_ROOT/emulator/emulator -avd ci-test-pixel-x86-64-api29 -no-window -no-boot-anim -no-audio &
            - ./script/ci-wait-for-emulator.sh #wait until ready
            # Run instrumentation tests
            - ./script/ci-instrumentation-tests-without-mailserver.sh 2 0

        - name: Instrumentation tests(No email server) - part 2
          commands:
            # Setup and run an emulator
            - $ANDROID_SDK_ROOT/emulator/emulator -accel-check
            - echo -ne '\n' | avdmanager -v create avd --name ci-test-pixel-x86-64-api29 --package "system-images;android-29;google_apis;x86_64" --device 'pixel' --abi 'google_apis/x86_64'
            - cat ~/.android/avd/ci-test-pixel-x86-64-api29.avd/config.ini
            - $ANDROID_SDK_ROOT/emulator/emulator -list-avds #debug
            - $ANDROID_SDK_ROOT/emulator/emulator -avd ci-test-pixel-x86-64-api29 -no-window -no-boot-anim -no-audio &
            - ./script/ci-wait-for-emulator.sh #wait until ready
            # Run instrumentation tests
            - ./script/ci-instrumentation-tests-without-mailserver.sh 2 1

        - name: Instrumentation tests with email server
          commands:
            # Run an email server
            - cd docker-mailserver && ./run_email_server.sh && cd -
            # Setup and run an emulator
            - $ANDROID_SDK_ROOT/emulator/emulator -accel-check
            - echo -ne '\n' | avdmanager -v create avd --name ci-test-pixel-x86-64-api29 --package "system-images;android-29;google_apis;x86_64" --device 'pixel' --abi 'google_apis/x86_64'
            - cat ~/.android/avd/ci-test-pixel-x86-64-api29.avd/config.ini
            - $ANDROID_SDK_ROOT/emulator/emulator -list-avds #debug
            - $ANDROID_SDK_ROOT/emulator/emulator -avd ci-test-pixel-x86-64-api29 -no-window -no-boot-anim -no-audio &
            - ./script/ci-wait-for-emulator.sh #wait until ready
            # Run instrumentation tests
            - ./script/ci-instrumentation-tests-with-mailserver.sh
      epilogue:
        on_fail:
          commands:
            # store errors log
            - echo "Store errors log"
            - ls -a
            - artifact push job --expire-in 1w FlowCrypt/build/reports/androidTests/connected/flavors/DEVTEST/
            - echo "Store screenshots"
            - adb pull "/mnt/sdcard/Download"
            - adb shell ls /mnt/sdcard/Download
            - artifact push job --expire-in 1w Download
        on_pass:
          commands:
            # store cache
            - echo "Store cache"
            - find ~/.gradle/caches/ -name "*.lock" -type f -delete # https://medium.com/cirruslabs/mastering-gradle-caching-and-incremental-builds-37eb1af7fcde
            - cache has_key $GRADLE_CACHE || cache store $GRADLE_CACHE .gradle
            - cache has_key $ANDROID_SDK_CACHE || cache store $ANDROID_SDK_CACHE $ANDROID_SDK_ROOT
            - cache has_key $BUILD_NATIVE_CACHE || cache store $BUILD_NATIVE_CACHE FlowCrypt/.externalNativeBuild
            - cache has_key $BUILD_CACHE || cache store $BUILD_CACHE FlowCrypt/build